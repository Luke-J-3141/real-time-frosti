<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    <title>FROSTI Ray Tracing</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="canvas-container">
            <canvas id="canvas" width="600" height="600"></canvas>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">−</button>
                <button class="zoom-btn" id="zoomReset">⌂</button>
            </div>
            <div class="zoom-info" id="zoomInfo">
                Zoom: 100% | Pan: Drag to move
            </div>
            <div class="graph-overlay"></div>
        </div>
        <div class="controls">
            <div class="controls-header">
                <div class="controls-title">FROSTI Ray Tracing</div>
                <div class="controls-subtitle">Interactive Physics Simulation</div>
            </div>
            
            <div class="controls-content">
                <div class="control-section">
                    <h3>Simulation Controls</h3>
                    <div class="control-content">
                        <div class="button-group">
                            <button id="startBtn">Start Simulation</button>
                            <button id="resetBtn">Reset</button>
                            <button id="clearRay">Clear Rays</button> 
                            <button id="clearHist">Clear Histogram</button> 
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Ray Parameters</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Ray Emission Rate <span class="value" id="emissionRateValue">1</span></label>
                            <input type="range" id="emissionRate" min="1" max="3" step="1" value="1">
                        </div>
                        
                        <div class="control-group">
                            <label>Max Bounces <span class="value" id="maxBouncesValue">8</span></label>
                            <input type="range" id="maxBounces" min="2" max="20" step="1" value="8">
                        </div>
                        
                        <div class="control-group">
                            <label>Ray Speed <span class="value" id="raySpeedValue">4</span></label>
                            <input type="range" id="raySpeed" min="0.5" max="10" step="0.1" value="4">
                        </div>
                        
                        <div class="control-group">
                            <label>Ray Lifetime <span class="value" id="rayLifetimeValue">400</span></label>
                            <input type="range" id="rayLifetime" min="100" max="800" step="50" value="400">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Reflector Geometry</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Source Width <span class="value" id="sourceLengthValue">2.0 mm</span></label>
                            <input type="range" id="sourceLength" min="10" max="500" step="10" value="200">
                            <!-- 0.1cm to 5.0cm in 0.1cm steps -->
                        </div>
                        
                        <div class="control-group">
                            <label>Source Tilt (radians) <span class="value" id="thetaValue">0.69</span></label>
                            <input type="range" id="theta" min="0" max="1.5" step="0.01" value="0.69">
                        </div>
                        
                        <div class="control-group">
                            <label>Distance from Origin <span class="value" id="dist_sor_tar_Value">50.0 mm</span></label>
                            <input type="range" id="dist_sor_tar" min="100" max="10000" step="10" value="5000">
                            <!-- 1.0cm to 10.0cm in 0.1cm steps -->
                        </div>
                
                        <div class="control-group">
                            <label>Target Width <span class="value" id="targetLengthValue">20.0 mm</span></label>
                            <input type="range" id="targetLength" min="50" max="6000" step="10" value="2000">
                            <!-- 0.5cm to 6.0cm in 0.1cm steps -->
                        </div>

                        <div class="control-group">
                            <label>Vertical Offset <span class="value" id="verticalOffsetValue">0.1 cm</span></label>
                            <input type="range" id="verticalOffset" min="0" max="500" step="5" value="10">
                            <!-- 0cm to 5.0cm in 0.05cm steps -->
                        </div>
                    </div>
                </div>
                            
                <div class="physics-info">
                    <strong>Description:</strong><br>
                    • Start the simulation, while running you are free to change parameters and see their effects.<br>
                    • Visualize how the FROSTI reflectors work, adjust the control parameters 
                    "Target Width", "Source Width", "Source Tilt", and "Distance from Origin"
                    and see how the Elliptical Reflectors change.<br>
                    • Tune the Ray properties to see how that effects the simulation. <br>
                    • If you want to reset the rays or the histogram without stopping the simulation, use the "Clear Rays" or "Clear Histogram" buttons.<br>
                    • On mobile: Tap section headers to collapse/expand controls to save space.
                </div>
            </div>
        </div>
    </div>

    <!-- Load modules in dependency order -->
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Canvas and viewport parameters - Mobile responsive
        let canvasWidth = Math.max(1500, window.innerWidth - 32);
        let canvasHeight = Math.max(canvasWidth, window.innerHeight - 32); // Keep square aspect ratio
        console.log(`Canvas size: ${canvasWidth} x ${canvasHeight}`);

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        let centerX = canvasWidth / 2;
        let centerY = canvasHeight / 2;
        
        // Zoom and pan state
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // Physics constants
        const EPS = 1e-6;
        // Simulation stateg
        let rays = [];
        let isRunning = false;
        let animationId = null;
        let frameCount = 0;

        // Get current values
        let theta, dist_sor_tar, sourceLength, targetLength, verticalOffset;
        let emissionRate, maxBounces, raySpeed, rayLifetime;
        let a, b, z0, voffset;
    </script>

    <script src="js/controls-mobile.js"></script>
    <script src="js/controls.js"></script>
    <script src="js/unitsGrid.js"></script>
    <script src="js/geometry.js"></script>
    <script src="js/rays.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/simulation.js"></script>
    <script src="js/distribution.js"></script>
    <script src="js/KDE.js"></script>
    <script src="js/zoom.js"></script>
    <script src="js/termination.js"></script>
    <script src="js/constraints.js"></script>

    <script>
        // Update display values on control change
        Object.values(controls).forEach(control => {
            control.addEventListener('input', () => {
                updateValues();
                if (!isRunning) {
                    redraw();
                }
            });
        });
        //local
        // Initial setup
        updateValues();
        updateZoomInfo();
        autoCenter();
        
        // Initial render - draw everything on first load
        redraw();
    </script>
</body>
</html>