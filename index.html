<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    <title>FROSTI Ray Tracing</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="canvas-container">
            <canvas id="canvas" width="600" height="600"></canvas>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">−</button>
                <button class="zoom-btn" id="zoomReset">⌂</button>
            </div>
            <div class="zoom-info" id="zoomInfo">
                Zoom: 100% | Pan: Drag to move
            </div>
            <div class="graph-overlay"></div>
        </div>
        <div class="controls">
            <div class="controls-header">
                <div class="controls-title">FROSTI Ray Tracing</div>
                <div class="controls-subtitle">Interactive Physics Simulation</div>
            </div>
            
            <div class="controls-content">
                <div class="control-section">
                    <h3>Simulation Controls</h3>
                    <div class="control-content">
                        <div class="button-group">
                            <button id="startBtn">Start Simulation</button>
                            <button id="resetBtn">Reset</button>
                            <button id="clearRay">Clear Rays</button> 
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Overlay Controls</h3>
                    <div class="control-content">
                        <div class="button-group">
                            <button id="resetOverlays">Reset Overlays</button>
                            <button id="toggleKDE">Toggle KDE</button>
                            <button id="toggleHistogram">Toggle Histogram</button>
                            <button id="toggleThermalOverlay">Toggle Thermal Overlay</button>
                        </div>
                    </div>
                </div>            
                
                <div class="control-section">
                    <h3>Ray Parameters</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Ray Emission Rate <span class="value" id="emissionRateValue">1</span></label>
                            <input type="range" id="emissionRate" min="1" max="3" step="1" value="1">
                        </div>
                        
                        <div class="control-group">
                            <label>Max Bounces <span class="value" id="maxBouncesValue">8</span></label>
                            <input type="range" id="maxBounces" min="0" max="5" step="1" value="5">
                        </div>
                        
                        <div class="control-group">
                            <label>Ray Speed <span class="value" id="raySpeedValue">30</span></label>
                            <input type="range" id="raySpeed" min="5" max="50" step="0.1" value="30">
                        </div>
                        
                        <div class="control-group">
                            <label>Ray Lifetime <span class="value" id="rayLifetimeValue">600</span></label>
                            <input type="range" id="rayLifetime" min="100" max="800" step="50" value="600">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Reflector Geometry</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Source Width <span class="value" id="sourceLengthValue">2.0 mm</span></label>
                            <input type="range" id="sourceLength" min="10" max="500" step="10" value="200">
                        </div>
                        
                        <div class="control-group">
                            <label>Source Tilt (radians) <span class="value" id="thetaValue">0.9</span></label>
                            <input type="range" id="theta" min="0" max="1.4" step="0.01" value="0.9">
                        </div>
                        
                        <div class="control-group">
                            <label>Distance from Origin <span class="value" id="dist_sor_tar_Value">50.0 mm</span></label>
                            <input type="range" id="dist_sor_tar" min="1000" max="10000" step="10" value="7500">
                        </div>
                
                        <div class="control-group">
                            <label>Target Width <span class="value" id="targetLengthValue">40.0 mm</span></label>
                            <input type="range" id="targetLength" min="50" max="8000" step="10" value="4000">
                        </div>

                        <div class="control-group">
                            <label>Vertical Offset <span class="value" id="verticalOffsetValue">100 mm</span></label>
                            <input type="range" id="verticalOffset" min="0" max="20000" step="5" value="10000">
                        </div>
                    </div>
                </div>
                <div class="physics-info">
                    <strong>Help:</strong><br>
                    Click 'z' key to see hotkey assignments for the simulation.<br>
                </div>
            </div>
        </div>
    </div>

    <!-- Load modules in dependency order -->
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Canvas and viewport parameters - Mobile responsive
        let canvasWidth = Math.max(1500, window.innerWidth - 32);
        let canvasHeight = Math.max(canvasWidth, window.innerHeight - 32); // Keep square aspect ratio
        console.log(`Canvas size: ${canvasWidth} x ${canvasHeight}`);

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        let centerX = canvasWidth / 2;
        let centerY = canvasHeight / 2;
        
        // Zoom and pan state
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // Physics constants
        const EPS = 1e-6;
        // Simulation stateg
        let rays = [];
        let isRunning = false;
        let animationId = null;
        let frameCount = 0;

        // Get current values
        let theta, dist_sor_tar, sourceLength, targetLength, verticalOffset;
        let emissionRate, maxBounces, raySpeed, rayLifetime;
        let a, b, z0, voffset;
    </script>

    <script src="js/controls-mobile.js"></script>
    <script src="js/unitsGrid.js"></script>
    <script src="js/controls.js"></script>
    <script src="js/geometry.js"></script>
    <script src="js/rays.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/simulation.js"></script>
    <script src="js/distribution.js"></script>
    <script src="js/KDE.js"></script>
    <script src="js/zoom.js"></script>
    <script src="js/termination.js"></script>
    <script src="js/testmass_vis.js"></script>
    <script src="js/constraints.js"></script>
    <script src="js/preformance.js"></script>

    <script>
        // Hotkey help display
        let helpVisible = false;
        let helpElement = null;

        function createHelpDisplay() {
            if (helpElement) return helpElement;
            
            helpElement = document.createElement('div');
            helpElement.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px;
                border-radius: 8px;
                font-family: monospace;
                font-size: 14px;
                line-height: 1.4;
                z-index: 1000;
                white-space: pre-line;
                border: 2px solid #4a90e2;
            `;
            
            helpElement.textContent = `
            HOTKEY ASSIGNMENTS:

            Histagram Overlay:
            r - Reset histogram and KDE
            h - Toggle histogram 

            KDE Overlay:
            k - Toggle KDE 
            n - Increase KDE binwidth
            m - Decrease KDE binwidth
            b - change KDE fitting method

            "Heating" Overlay:
            t - Toggle overlay visibility
            - - Decrease 'Diffusion' rate (-0.1)
            + - Increase 'Diffusion' rate (+0.1)
            [ - Decrease tint strength (-0.1)
            ] - Increase tint strength (+0.1)
            < - Decrease something
            > - Increase something
            `;
            
            document.body.appendChild(helpElement);
            return helpElement;
        }

        function toggleHelp() {
            if (helpVisible) {
                hideHelp();
            } else {
                showHelp();
            }
        }

        function showHelp() {
            if (!helpVisible) {
                createHelpDisplay();
                helpElement.style.display = 'block';
                helpVisible = true;
            }
        }

        function hideHelp() {
            if (helpVisible && helpElement) {
                helpElement.style.display = 'none';
                helpVisible = false;
            }
        }

        // Simple keyboard controls
        document.addEventListener('keydown', (e) => {
            // Show help when H is held
            if (e.key === 'z' || e.key === 'Z') {
                toggleHelp();
                return;
            }
        }
        )

        // Update display values on control change
        Object.values(controls).forEach(control => {
            control.addEventListener('input', () => {
                updateValues();
                if (!isRunning) {
                    redraw();
                }
            });
        });
        //local
        // Initial setup
        updateValues();
        updateZoomInfo();
        autoCenter();
        
        // Initial render - draw everything on first load
        redraw();
    </script>
</body>
</html>